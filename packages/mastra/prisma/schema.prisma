// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "esm"
}

datasource db {
  provider = "sqlite"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "../generated"
  config   = "./zod-generator.json"
}

// 枚举类型定义
enum ProviderType {
  // 主流供应商
  openai
  openai_compatible
  anthropic
  google
  gemini
  deepseek
  groq
  mistral
  // 网关供应商
  netlify
  openrouter
  vercel
  // 中国供应商
  qwenlm
  alibaba
  alibaba_cn
  zhipuai
  moonshotai
  moonshotai_cn
  modelscope
  // Azure 和其他
  azure_openai
  xai
  xai_cn
  // 其他供应商
  abacus
  agentrouter
  aihubmix
  amazon_bedrock
  azure
  azure_cognitive_services
  bailing
  baseten
  berget
  cerebras
  chutes
  cloudflare_ai_gateway
  cloudflare_workers_ai
  cohere
  cortecs
  deepinfra
  fastrouter
  fireworks_ai
  firmware
  friendli
  github_copilot
  github_models
  gitlab
  google_vertex
  google_vertex_anthropic
  helicone
  huggingface
  iflowcn
  inception
  inference
  io_net
  jiekou
  kilo
  kimi_for_coding
  kuae_cloud_coding_plan
  llama
  lmstudio
  lucidquery
  minimax
  minimax_cn
  minimax_cn_coding_plan
  minimax_coding_plan
  moark
  morph
  nano_gpt
  nebius
  nova
  novita_ai
  nvidia
  ollama_cloud
  opencode
  ovhcloud
  perplexity
  poe
  privatemode_ai
  provider_302ai
  requesty
  sap_ai_core
  scaleway
  siliconflow
  siliconflow_cn
  stackit
  stepfun
  submodel
  synthetic
  togetherai
  upstage
  v0
  venice
  vivgrid
  vultr
  wandb
  xiaomi
  zai
  zai_coding_plan
  zenmux
  zhipuai_coding_plan
}

enum KnowledgeRecognition {
  off
  on
}

// Provider模型
model Provider {
  id         String       @id @default(uuid())
  type       ProviderType
  name       String
  apiKey     String       @default("")
  apiHost    String       @default("")
  apiVersion String?
  enabled    Boolean      @default(true)
  isSystem   Boolean      @default(false)
  isAuthed   Boolean      @default(false)
  notes      String?
  isGateway  Boolean      @default(false) // 是否为网关
  modelCount Int?         @default(0) // 模型数量统计
  docsUrl    String? // 文档URL

  // 一对多关系：一个供应商有多个分组（通过分组间接关联模型）
  groups Group[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  Assistant Assistant[]
}

// 助手模型
model Assistant {
  id                   String                @id @default(uuid())
  name                 String
  prompt               String
  type                 String                @default("assistant")
  emoji                String?
  description          String?
  enableWebSearch      Boolean               @default(false)
  webSearchProviderId  String?
  enableGenerateImage  Boolean               @default(false)
  knowledgeRecognition KnowledgeRecognition?

  // 关系
  model          Model?               @relation("AssistantModel", fields: [modelId], references: [id])
  modelId        String?
  provider       Provider?            @relation(fields: [providerId], references: [id])
  providerId     String?
  settings       AssistantSettings?
  topics         Topic[]
  knowledgeBases KnowledgeBase[]
  mcpServers     MCPAssistantServer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 智能体模型
model Agent {
  id                   String                @id @default(uuid())
  name                 String
  prompt               String
  type                 String                @default("agent")
  emoji                String?
  description          String?
  enableWebSearch      Boolean               @default(false)
  webSearchProviderId  String?
  enableGenerateImage  Boolean               @default(false)
  knowledgeRecognition KnowledgeRecognition?

  // 关系
  groups         AgentAgentGroup[]
  settings       AssistantSettings?
  topics         Topic[]
  knowledgeBases KnowledgeBase[]
  mcpServers     MCPAgentServer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgentGroup {
  id        String            @id @default(uuid())
  name      String            @unique
  label     String
  agents    AgentAgentGroup[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

// Agent和AgentGroup的多对多关系
model AgentAgentGroup {
  agent        Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId      String
  agentGroup   AgentGroup @relation(fields: [agentGroupId], references: [id], onDelete: Cascade)
  agentGroupId String

  @@id([agentId, agentGroupId])
}

// 主题模型
model Topic {
  id                   String  @id @default(uuid())
  name                 String
  prompt               String?
  pinned               Boolean @default(false)
  isNameManuallyEdited Boolean @default(false)

  // 关系
  assistant   Assistant? @relation(fields: [assistantId], references: [id])
  assistantId String?
  agent       Agent?     @relation(fields: [agentId], references: [id])
  agentId     String?

  modelId String? @unique

  knowledgeBases TopicKnowledgeBase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 文件类型
model FileType {
  id          String @id @default(uuid())
  name        String
  origin_name String
  path        String
  size        Int
  ext         String
  type        String // FileTypes 枚举值
  count       Int
  tokens      Int?

  created_at DateTime @default(now())
}

// 模型
model Model {
  id          String  @id
  name        String
  owned_by    String?
  description String?
  isSystem    Boolean @default(false)
  sort        Int     @default(0) // 排序字段（用于分组内排序）

  // 模型能力字段
  contextLength         Int? // 上下文长度 (如 128K 转换为数字)
  supportsAttachments   Boolean @default(false) // 是否支持附件
  supportsTools         Boolean @default(false) // 是否支持工具
  supportsReasoning     Boolean @default(false) // 是否支持推理
  supportsImage         Boolean @default(false) // 是否支持图像
  supportsAudio         Boolean @default(false) // 是否支持音频
  supportsVideo         Boolean @default(false) // 是否支持视频
  supportsEmbedding     Boolean @default(false) // 是否支持嵌入
  inputPricePerMillion  Float? // 输入价格（每百万token）
  outputPricePerMillion Float? // 输出价格（每百万token）

  // 关系：模型属于一个分组（多对一）
  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  assistants Assistant[]     @relation("AssistantModel")
  rerankFor  KnowledgeBase[] @relation("RerankModel")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 助手设置
model AssistantSettings {
  id               String   @id @default(uuid())
  contextCount     Int
  temperature      Float
  topP             Float
  maxTokens        Int?
  enableMaxTokens  Boolean  @default(false)
  streamOutput     Boolean  @default(true)
  hideMessages     Boolean  @default(false)
  customParameters Json? // 自定义参数
  reasoning_effort String? // 'low', 'medium', 'high', 'auto'
  qwenThinkMode    Boolean?
  toolUseMode      String? // 'function' 或 'prompt'

  // 关系
  assistant      Assistant? @relation(fields: [assistantId], references: [id])
  assistantId    String?    @unique
  agent          Agent?     @relation(fields: [agentId], references: [id])
  agentId        String?    @unique
  defaultModelId String?
}

// 知识库
model KnowledgeBase {
  id            String  @id @default(uuid())
  name          String
  dimensions    Int
  description   String?
  documentCount Int?
  chunkSize     Int?
  chunkOverlap  Int?
  threshold     Float?
  version       Int

  // 关系
  assistants    Assistant[]
  agents        Agent[]
  modelId       String
  rerankModel   Model?               @relation("RerankModel", fields: [rerankModelId], references: [id])
  rerankModelId String?
  items         KnowledgeItem[]
  topics        TopicKnowledgeBase[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// 知识项
model KnowledgeItem {
  id                 String  @id @default(uuid())
  uniqueId           String?
  uniqueIdsJson      Json? // 存储String[]
  type               String // KnowledgeItemType 枚举值
  content            Json // string 或 FileType
  remark             String?
  processingStatus   String? // ProcessingStatus 枚举值
  processingProgress Float?
  processingError    String?
  retryCount         Int?

  // 关系
  knowledgeBase KnowledgeBase @relation(fields: [baseId], references: [id])
  baseId        String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// Topic和KnowledgeBase的多对多关系
model TopicKnowledgeBase {
  topic           Topic         @relation(fields: [topicId], references: [id])
  topicId         String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id])
  knowledgeBaseId String

  @@id([topicId, knowledgeBaseId])
}

// MCP服务器
model MCPServer {
  id                String  @id @default(uuid())
  name              String
  type              String? // 'stdio' | 'sse' | 'inMemory' | 'streamableHttp'
  description       String?
  baseUrl           String?
  command           String?
  registryUrl       String?
  argsJson          Json? // 存储String[]
  env               Json? // Record<string, string>
  isActive          Boolean @default(false)
  disabledToolsJson Json? // 存储String[]
  configSample      Json? // MCPConfigSample
  headers           Json? // Record<string, string>
  searchKey         String?
  provider          String? // 提供者名称
  providerUrl       String? // 提供者网站或文档的URL
  logoUrl           String? // 服务器logo的URL
  tagsJson          Json? // 存储String[]
  timeout           Int? // 请求超时时间(秒)

  // 关系
  tools                MCPTool[]
  prompts              MCPPrompt[]
  assistants           MCPAssistantServer[]
  agents               MCPAgentServer[]
  resources            MCPResource[]
  configSampleRelation MCPConfigSample?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Assistant和MCPServer的多对多关系
model MCPAssistantServer {
  assistant   Assistant @relation(fields: [assistantId], references: [id])
  assistantId String
  mcpServer   MCPServer @relation(fields: [mcpServerId], references: [id])
  mcpServerId String

  @@id([assistantId, mcpServerId])
}

// Agent和MCPServer的多对多关系
model MCPAgentServer {
  agent       Agent     @relation(fields: [agentId], references: [id])
  agentId     String
  mcpServer   MCPServer @relation(fields: [mcpServerId], references: [id])
  mcpServerId String

  @@id([agentId, mcpServerId])
}

// MCP工具
model MCPTool {
  id          String  @id @default(uuid())
  name        String
  description String?
  inputSchema Json // MCPToolInputSchema

  // 关系
  server   MCPServer @relation(fields: [serverId], references: [id])
  serverId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// MCP提示
model MCPPrompt {
  id          String  @id @default(uuid())
  name        String
  description String?
  arguments   Json? // MCPPromptArguments[]

  // 关系
  server   MCPServer @relation(fields: [serverId], references: [id])
  serverId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// MCP资源
model MCPResource {
  id          String  @id @default(uuid())
  uri         String
  name        String
  description String?
  mimeType    String?
  size        Int?
  text        String?
  blob        String?

  // 关系
  server   MCPServer @relation(fields: [serverId], references: [id])
  serverId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 配置样本
model MCPConfigSample {
  id       String @id @default(uuid())
  command  String
  argsJson Json? // 存储String[]
  env      Json? // Record<string, string>

  // 关系
  server   MCPServer @relation(fields: [serverId], references: [id])
  serverId String    @unique
}

// 快速短语
model QuickPhrase {
  id      String @id @default(uuid())
  title   String
  content String
  order   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 分组模型
model Group {
  id         String  @id @default(uuid())
  name       String
  providerId String
  isDefault  Boolean @default(false)

  // 关系：分组属于一个供应商
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  // 关系：分组包含多个模型（一对多）
  models   Model[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, name])
  @@index([providerId])
}
