# 重构策略

## 依赖与重复

> "依赖是软件开发在所有规模上的核心问题。如果依赖是问题，重复是症状。"

**关系**：
- 重复通常表现为重复逻辑——相同的条件表达式出现在多个地方
- 对象非常适合抽象逻辑的重复
- 重复也出现在数据中
- 消除重复程序中的重复就消除了依赖

**为什么TDD的第二条规则是消除重复**：
- 在进行下一个测试之前消除重复，最大化只用一次更改就能让下一个测试运行的机会

## 隔离更改（Isolate Change）

> "如何更改多部分方法或对象的一部分？首先，隔离需要更改的部分。"

**流程**：
1. 提取需要更改的部分
2. 在隔离中工作，不影响其他部分

**示例**：
```javascript
// 原始代码
return new Note(source.amount / rate, currency);

// 隔离rate访问
return new Note(source.amount / findRate(), currency);
private int findRate() {
    return rate;
}
```

**收益**：
- 可以在隔离中处理findRate()，不影响convert()的其他部分
- 类似外科手术——只暴露需要操作的部分

## 数据迁移（Migrate Data）

> "如何从一个表示迁移到另一个？临时复制数据。"

**内部到外部版本**：
1. 以新格式添加实例变量
2. 在设置旧格式的任何地方设置新格式变量
3. 在使用旧格式的任何地方使用新格式变量
4. 删除旧格式
5. 更改外部接口以反映新格式

**API优先版本**：
1. 以新格式添加参数
2. 从新格式参数转换到旧格式内部表示
3. 删除旧格式参数
4. 用新格式替换旧格式的使用
5. 删除旧格式

## 一对多（One to Many）

将单个变量转换为集合的渐进式重构：
1. 初始化集合
2. 设置单个变量的同时也添加到集合
3. 使用集合而不是单个变量
4. 删除未使用的单个变量

## 提取方法（Extract Method）

最常见的重构模式：
- 识别可以组合的代码片段
- 给它一个描述性的名称
- 用方法调用替换代码片段

## 内联方法（Inline Method）

提取方法的逆操作：
- 当方法的抽象不再增加价值时
- 方法体与其名称一样清晰时
- 简化不必要间接时

## 提取接口（Extract Interface）

从具体类创建接口：
- 允许客户端与实现解耦
- 支持多种实现
- 使测试更容易

## 移动方法（Move Method）

将方法移到更合适的类：
- 方法使用另一个类的数据多于自己类的数据
- 改善类之间的职责分配

## 方法对象（Method Object）

> "如何表示需要多个参数和局部变量的复杂方法？将方法变成对象。"

**流程**：
1. 创建与方法参数相同的对象
2. 使局部变量也成为对象的实例变量
3. 创建一个名为"run()"的方法，体与原始方法相同
4. 在原始方法中，创建新对象并调用run()

**何时使用**：
- 方法有太多参数和局部变量
- 需要分解复杂方法但难以提取部分
- 想要给复杂逻辑一个"家"
